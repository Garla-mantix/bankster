@page "/DepositWithdraw"
@inject IAccountService AccountService

<PageTitle>Bankster - Deposit / Withdraw</PageTitle>

<div class="page-enter">
    <div class="card">
        <div class="card-header-section">
            <h1>Deposit / Withdraw</h1>
            <p class="card-subtitle">Add or remove funds from your accounts</p>
        </div>

        <EditForm Model="_model" OnValidSubmit="SubmitTransactionAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="accountfield">
                <label>Select Account</label>
                <InputSelect @bind-Value="_model.SelectedAccountId">
                    <option value="@Guid.Empty">Choose account</option>
                    @foreach (var account in _accounts)
                    {
                        <option value="@account.Id">
                            @account.Name (@account.Balance.ToString("F2") @account.CurrencyType)
                        </option>
                    }
                </InputSelect>
            </div>

            <div class="accountfield">
                <label>Transaction Type</label>
                <InputSelect @bind-Value="_model.TransactionType">
                    <option value="">Choose type</option>
                    <option value="@TransactionType.Deposit">Deposit</option>
                    <option value="@TransactionType.Withdrawal">Withdraw</option>
                </InputSelect>
            </div>

            <div class="accountfield" hidden="@(_model.TransactionType != TransactionType.Withdrawal)">
                <label>Category</label>
                <InputSelect @bind-Value="_model.Category">
                    @foreach (var category in Enum.GetValues<BudgetCategory>())
                    {
                        <option value="@category">@category</option>
                    }
                </InputSelect>
            </div>

            <div class="accountfield">
                <label>Amount</label>
                <InputNumber @bind-Value="_model.Amount" />
            </div>

            <button class="formbutton" type="submit">Apply</button>
        </EditForm>

        @if (!string.IsNullOrEmpty(_message))
        {
            <div style="margin-top: 1rem;">
                <p class="@(_isSuccess ? "success-message" : "error-message")">@_message</p>
            </div>
        }
    </div>
</div>

@code {
    // Variable storing data for current transaction
    private readonly TransactionModel _model = new();

    // List of existing accounts
    private List<IBankAccount> _accounts = new();

    // Status message that gets assigned different values depending on validation
    private string? _message;

    // Indicates whether transaction went through or not
    private bool _isSuccess;

    // Initializing component by loading existing bank accounts to the UI
    protected override async Task OnInitializedAsync()
    {
        await LoadAccountsAsync();
    }

    // Async task for loading existing accounts
    private async Task LoadAccountsAsync()
    {
        _accounts = await AccountService.GetAccounts();
    }

    // Async task for making transactions
    private async Task SubmitTransactionAsync()
    {
        // Validation
        if (_model.SelectedAccountId == Guid.Empty)
        {
            _message = "Please select an account.";
            Console.WriteLine(_message);
            _isSuccess = false;
            return;
        }
        if (_model.Amount is null or <= 0)
        {
            _message = "Amount must be greater than zero.";
            Console.WriteLine(_message);
            _isSuccess = false;
            return;
        }

        try
        {
            var selectedAccountId = _model.SelectedAccountId;

            // Performs transaction
            switch (_model.TransactionType)
            {
                case TransactionType.Deposit:
                    await AccountService.DepositAsync(_model.SelectedAccountId, _model.Amount!.Value);
                    _message = $"Deposited {_model.Amount} successfully!";
                    _isSuccess = true;
                    break;

                case TransactionType.Withdrawal:
                    await AccountService.WithdrawAsync(_model.SelectedAccountId, _model.Amount!.Value, _model.Category);
                    _message = $"Withdrew {_model.Amount} successfully!";
                    _isSuccess = true;
                    break;

                default:
                    _message = "Please select a transaction type.";
                    _isSuccess = false;
                    return;
            }

            await LoadAccountsAsync();
            _model.SelectedAccountId = selectedAccountId;
            _model.Amount = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _message = $"Error: {ex.Message}";
            Console.WriteLine(_message);
            _isSuccess = false;
        }
    }

    /// <summary>
    /// Model for transactions.
    /// </summary>
    private class TransactionModel
    {
        public Guid SelectedAccountId { get; set; } = Guid.Empty;
        public TransactionType TransactionType { get; set; }
        public decimal? Amount { get; set; }
        public BudgetCategory Category { get; set; } = BudgetCategory.None;
    }
}
