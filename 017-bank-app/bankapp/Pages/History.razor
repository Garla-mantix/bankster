@page "/History"
@inject IAccountService AccountService
@inject SelectedAccountStatus SelectedStatus

<PageTitle>Bankster - History</PageTitle>

<div class="page-enter">
    <h1>History</h1>
    <p style="margin-bottom: 1.5rem;">Filter and sort your transaction records.</p>

    <EditForm Model="_filterModel">
        <div class="accountfield">
            <label>Select Account</label>
            <InputSelect TValue="Guid?"
                         Value="_filterModel.SelectedAccountId"
                         ValueChanged="(Guid? v) => { _filterModel.SelectedAccountId = v; ApplyFilters(); }"
                         ValueExpression="() => _filterModel.SelectedAccountId">
                <option value="">Choose account</option>
                @foreach (var account in _accounts)
                {
                    <option value="@account.Id">@account.Name (@account.CurrencyType)</option>
                }
            </InputSelect>
        </div>

        @if (_filterModel.SelectedAccountId != null
             && _accounts.Any(a => a.Id == _filterModel.SelectedAccountId.Value))
        {
            <div class="filter-section">
                <div class="accountfield">
                    <label>Transaction Type</label>
                    <InputSelect TValue="TransactionType?"
                                 Value="_filterModel.TransactionType"
                                 ValueChanged="(TransactionType? v) => { _filterModel.TransactionType = v; ApplyFilters(); }"
                                 ValueExpression="() => _filterModel.TransactionType">
                        <option value="">All types</option>
                        <option value="@TransactionType.Deposit">Deposit</option>
                        <option value="@TransactionType.Withdrawal">Withdrawal</option>
                        <option value="@TransactionType.Transfer">Transfer</option>
                    </InputSelect>
                </div>

                <div class="accountfield">
                    <label>Category</label>
                    <InputSelect TValue="BudgetCategory?"
                                 Value="_filterModel.Category"
                                 ValueChanged="(BudgetCategory? v) => { _filterModel.Category = v; ApplyFilters(); }"
                                 ValueExpression="() => _filterModel.Category">
                        <option value="">All categories</option>
                        @foreach (var category in Enum.GetValues<BudgetCategory>())
                        {
                            <option value="@category">@category</option>
                        }
                    </InputSelect>
                </div>

                <div class="accountfield">
                    <label>From Date</label>
                    <InputDate TValue="DateTime?"
                               Value="_filterModel.FromDate"
                               ValueChanged="(DateTime? v) => { _filterModel.FromDate = v; ApplyFilters(); }"
                               ValueExpression="() => _filterModel.FromDate"/>
                </div>

                <div class="accountfield">
                    <label>To Date</label>
                    <InputDate TValue="DateTime?"
                               Value="_filterModel.ToDate"
                               ValueChanged="(DateTime? v) => { _filterModel.ToDate = v; ApplyFilters(); }"
                               ValueExpression="() => _filterModel.ToDate"/>
                </div>

                <div class="accountfield">
                    <label>Min Amount</label>
                    <InputNumber TValue="decimal?"
                                 Value="_filterModel.MinAmount"
                                 ValueChanged="(decimal? v) => { _filterModel.MinAmount = v; ApplyFilters(); }"
                                 ValueExpression="() => _filterModel.MinAmount"/>
                </div>

                <div class="accountfield">
                    <label>Max Amount</label>
                    <InputNumber TValue="decimal?"
                                 Value="_filterModel.MaxAmount"
                                 ValueChanged="(decimal? v) => { _filterModel.MaxAmount = v; ApplyFilters(); }"
                                 ValueExpression="() => _filterModel.MaxAmount"/>
                </div>

                <div class="accountfield">
                    <label>Sort By</label>
                    <InputSelect TValue="string"
                                 Value="_filterModel.SortOption"
                                 ValueChanged="(string v) => { _filterModel.SortOption = v; ApplyFilters(); }"
                                 ValueExpression="() => _filterModel.SortOption">
                        <option value="date_desc">Date (Newest)</option>
                        <option value="date_asc">Date (Oldest)</option>
                        <option value="amount_desc">Amount (High to Low)</option>
                        <option value="amount_asc">Amount (Low to High)</option>
                        <option value="type">Type</option>
                        <option value="category">Category</option>
                    </InputSelect>
                </div>
            </div>

            <div class="filter-actions">
                <button type="button" class="formbutton btn-secondary" @onclick="ResetFilters">Reset Filters</button>
            </div>
        }
    </EditForm>

    @if (_filterModel.SelectedAccountId == null ||
         !_accounts.Any(a => a.Id == _filterModel.SelectedAccountId.Value))
    {
        <div class="empty-state">
            <div class="empty-icon"><span class="bi bi-clock-history"></span></div>
            <p>Please select an account to view its history.</p>
        </div>
    }
    else if (_transactions == null)
    {
        <p>Loading transactions...</p>
    }
    else if (!_transactions.Any())
    {
        <div class="empty-state">
            <div class="empty-icon"><span class="bi bi-inbox"></span></div>
            <p>No transactions found.</p>
        </div>
    }
    else
    {
        <table class="history-table">
            <thead>
            <tr>
                <th>Date</th>
                <th>Account</th>
                <th>Type</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Related Account</th>
                <th>Description</th>
                <th>Balance After</th>
            </tr>
            </thead>
            <tbody>
                @foreach (var t in _transactions)
                {
                    <tr class="@GetTransactionRowClass(t.Type)">
                        <td>@t.Timestamp.ToString("d'/'M/yyyy (HH:mm)")</td>
                        <td>@GetAccountName(t.AccountId)</td>
                        <td><span class="badge @GetBadgeClass(t.Type)">@t.Type</span></td>
                        <td>@t.Category</td>
                        <td style="font-family: var(--font-mono); font-weight: 500;">@t.Amount.ToString("F2")</td>
                        <td>@t.RelatedAccountName</td>
                        <td>@t.Description</td>
                        <td style="font-family: var(--font-mono); font-weight: 500;">@t.BalanceAfter.ToString("F2")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    // Account shown in UI
    private List<BankAccount> _accounts = new();

    // Filtered transactions based on selection
    private List<Transaction>? _transactions = new();

    // Variable storing filter/sorting
    private readonly FilterModel _filterModel = new();

    // Initialize by loading accounts and creating new list for transactions
    protected override async Task OnInitializedAsync()
    {
        var accounts = await AccountService.GetAccounts();
        _accounts = accounts.Cast<BankAccount>().ToList();
        _filterModel.SelectedAccountId = null;
        _transactions = new();

        // Preselect clicked account from MyAccounts
        if (SelectedStatus.SelectedAccountId != Guid.Empty)
        {
            _filterModel.SelectedAccountId = SelectedStatus.SelectedAccountId.GetValueOrDefault();
            ApplyFilters();
            SelectedStatus.SelectedAccountId = Guid.Empty;
        }
    }

    // Applying filters
    private void ApplyFilters()
    {
        var selectedAccount = _filterModel.SelectedAccountId == null
            ? null
            : _accounts.FirstOrDefault(a => a.Id == _filterModel.SelectedAccountId.Value);

        if (selectedAccount == null)
        {
            _transactions = new();
            StateHasChanged();
            return;
        }

        IEnumerable<Transaction> query = selectedAccount.Transactions;

        var fromDate = _filterModel.FromDate?.Date;
        var toDateExclusive = _filterModel.ToDate?.Date.AddDays(1);

        if (fromDate.HasValue)
        {
            query = query.Where(t => t.Timestamp >= fromDate.Value);
        }
        if (toDateExclusive.HasValue)
        {
            query = query.Where(t => t.Timestamp < toDateExclusive.Value);
        }
        if (_filterModel.TransactionType.HasValue)
        {
            query = query.Where(t => t.Type == _filterModel.TransactionType.Value);
        }
        if (_filterModel.Category.HasValue)
        {
            query = query.Where(t => t.Category == _filterModel.Category.Value);
        }
        if (_filterModel.MinAmount.HasValue)
        {
            query = query.Where(t => t.Amount >= _filterModel.MinAmount.Value);
        }
        if (_filterModel.MaxAmount.HasValue)
        {
            query = query.Where(t => t.Amount <= _filterModel.MaxAmount.Value);
        }


        // Sorting results based on selections
        query = _filterModel.SortOption switch
        {
            "date_asc"    => query.OrderBy(t => t.Timestamp),
            "amount_asc"  => query.OrderBy(t => t.Amount),
            "amount_desc" => query.OrderByDescending(t => t.Amount),
            "type"        => query.OrderBy(t => t.Type),
            "category"    => query.OrderBy(t => t.Category),
            _             => query.OrderByDescending(t => t.Timestamp)
        };

        _transactions = query.ToList();
        StateHasChanged();
    }

    // Resetting filters
    private void ResetFilters()
    {
        _filterModel.TransactionType = null;
        _filterModel.Category = null;
        _filterModel.FromDate = null;
        _filterModel.ToDate = null;
        _filterModel.MinAmount = null;
        _filterModel.MaxAmount = null;
        _filterModel.SortOption = "date_desc";
        ApplyFilters();
    }

    // Getting name of account from ID
    private string GetAccountName(Guid id)
        => _accounts.FirstOrDefault(a => a.Id == id)?.Name ?? "Unknown";

    // Assigns CSS class according to transaction type (used for coloring rows).
    private static string GetTransactionRowClass(TransactionType type) => type switch
    {
        TransactionType.Deposit => "deposit-row",
        TransactionType.Withdrawal => "withdrawal-row",
        TransactionType.Transfer => "transfer-row",
        _ => string.Empty
    };

    // Badge class for transaction type
    private static string GetBadgeClass(TransactionType type) => type switch
    {
        TransactionType.Deposit => "badge-accent",
        TransactionType.Withdrawal => "badge-danger",
        TransactionType.Transfer => "badge-info",
        _ => string.Empty
    };

    // Model storing filtering and sorting selections
    private class FilterModel
    {
        public Guid? SelectedAccountId { get; set; } = null;
        public TransactionType? TransactionType { get; set; }
        public BudgetCategory? Category { get; set; }
        public DateTime? FromDate { get; set; }
        public DateTime? ToDate { get; set; }
        public decimal? MinAmount { get; set; }
        public decimal? MaxAmount { get; set; }
        public string SortOption { get; set; } = "date_desc";
    }
}
